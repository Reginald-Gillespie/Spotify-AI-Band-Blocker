(async()=>{for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var e;e=async function(){for(;null==Spicetify||!Spicetify.Player||null==Spicetify||!Spicetify.Menu||null==Spicetify||!Spicetify.LocalStorage;)await new Promise(e=>setTimeout(e,100));let p={url:"https://raw.githubusercontent.com/romiem/ai-bands/main/dist/ai-bands.json",cacheKey:"ai-bands:list",timeKey:"ai-bands:ts",enabledKey:"ai-bands:enabled",allowLikedKey:"ai-bands:allowLiked",tagSkipStatesKey:"ai-bands:tagSkipStates",ttl:864e5},e,S=new Map,g=new Map,d=new Set,r="false"!==Spicetify.LocalStorage.get(p.enabledKey),n="true"===Spicetify.LocalStorage.get(p.allowLikedKey);function u(){var e=Object.fromEntries(g);Spicetify.LocalStorage.set(p.tagSkipStatesKey,JSON.stringify(e))}if(c=Spicetify.LocalStorage.get(p.tagSkipStatesKey))try{var t=JSON.parse(c);g=new Map(Object.entries(t))}catch(e){console.error("[AI Blocker] Failed to parse tag skip states",e)}let a=[],i;async function o(e){var t=Date.now(),i=Spicetify.LocalStorage.get(p.timeKey),i=i?parseInt(i):0,a=Spicetify.LocalStorage.get(p.cacheKey);let o=[];if(a&&e)try{o=JSON.parse(a)}catch(e){console.error("[AI Blocker] Cache parse error",e)}if(e||t-i>p.ttl||0===o.length){console.log("[AI Blocker] Fetching new blocklist...");try{var r=await fetch(p.url);if(!r.ok)throw new Error("HTTP error! status: "+r.status);0<(o=await r.json()).length&&(Spicetify.LocalStorage.set(p.cacheKey,JSON.stringify(o)),Spicetify.LocalStorage.set(p.timeKey,t.toString()),console.log(`[AI Blocker] Updated cache with ${o.length} artists.`))}catch(e){console.error("[AI Blocker] Fetch failed, using cached data if available.",e)}}S.clear();var n,c,s=new Set;for(n of o){let e,t=[];if("string"==typeof n)e=n;else{if("object"!=typeof n||!n.name)continue;e=n.name,t=Array.isArray(n.tags)?n.tags:[]}var l,f=e.toLowerCase().trim();S.set(f,t);for(l of t)s.add(l)}let y=!1;for(c of d=s)g.has(c)||(g.set(c,!0),y=!0);y&&u(),w()}function w(){a=[];var e=Array.from(g.keys()).filter(e=>d.has(e)).sort();for(let i of e){var t=null==(t=g.get(i))||t,t=new Spicetify.Menu.Item("Skip: "+i,t,e=>{var t=!g.get(i);g.set(i,t),u(),e.setState(t),Spicetify.showNotification(`Tag "${i}" `+(t?"will be skipped":"allowed")),t&&r&&l()});a.push(t)}i&&(i.deregister(),(i=new Spicetify.Menu.SubMenu("AI Filter Tags",a)).register())}await o(!1),setInterval(()=>{console.log("[AI Blocker] Running scheduled ban list update..."),o(!1)},p.ttl),w(),i=new Spicetify.Menu.SubMenu("AI Filter Tags",a);var c=new Spicetify.Menu.Item("Block AI Bands",r,e=>{r=!r,Spicetify.LocalStorage.set(p.enabledKey,r.toString()),e.setState(r),Spicetify.showNotification("AI Blocking "+(r?"ON":"OFF")),r&&l()}),t=new Spicetify.Menu.Item("Allow Liked AI Songs",n,e=>{n=!n,Spicetify.LocalStorage.set(p.allowLikedKey,n.toString()),e.setState(n),Spicetify.showNotification("Allow Liked AI Songs "+(n?"ON":"OFF"))}),s=new Spicetify.Menu.Item("Update Blocklist",!1,async()=>{var t;Spicetify.showNotification("Updating blocklist..."),await o(!0),t=200,await new Promise(e=>setTimeout(e,t)),Spicetify.showNotification("Blocklist updated successfully!")});async function l(){if(r){var e,t=Spicetify.Player.data;if(t&&t.item&&t.item.artists){console.log("[AI Blocker] Current track artists: ",t.item.artists);for(e of t.item.artists.map(e=>e.name.toLowerCase().trim()))if(S.has(e)){var i=S.get(e)||[];if(0===i.length){if(!Spicetify.Player.isPlaying())return;if(n){var a=t.item.uri;if(a)try{if(await Spicetify.Platform.LibraryAPI.contains(a))return void console.log(`[AI Blocker] Detected AI Artist: ${e}, but song is liked. Allowing...`)}catch(e){console.error("[AI Blocker] Error checking if song is liked:",e)}}return console.log(`[AI Blocker] Detected AI Artist with no tags: ${e}. Skipping...`),Spicetify.Player.next(),void Spicetify.showNotification("Skipped AI Band: "+e.toUpperCase())}if(i.some(e=>!0===g.get(e))){if(!Spicetify.Player.isPlaying())return;if(n){var o,a=t.item.uri;if(a)try{if(await Spicetify.Platform.LibraryAPI.contains(a))return o=i.filter(e=>!0===g.get(e)),void console.log(`[AI Blocker] Detected AI Artist: ${e} with skippable tags: ${o.join(", ")}, but song is liked. Allowing...`)}catch(e){console.error("[AI Blocker] Error checking if song is liked:",e)}}i=i.filter(e=>!0===g.get(e));return console.log(`[AI Blocker] Detected AI Artist: ${e} with skippable tags: ${i.join(", ")}. Skipping...`),Spicetify.Player.next(),void Spicetify.showNotification(`Skipped AI Band: ${e.toUpperCase()} (${i.join(", ")})`)}}}}}new Spicetify.Menu.SubMenu("AI Band Blocker",[c,t,s]).register(),i.register(),Spicetify.Player.addEventListener("songchange",function(){e&&clearTimeout(e),e=setTimeout(l,450)}),l()},(async()=>{await e()})()})();